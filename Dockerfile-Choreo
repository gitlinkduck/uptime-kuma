# Stage 1: 构建新的 healthcheck
FROM golang:1.22.4-alpine AS healthcheck-builder
WORKDIR /build

# 创建一个简单的 healthcheck
RUN cat > healthcheck.go << 'EOF'
package main

import (
    "fmt"
    "net/http"
    "os"
    "time"
)

func main() {
    client := &http.Client{
        Timeout: 10 * time.Second,
    }
    
    resp, err := client.Get("http://localhost:3001")
    if err != nil {
        fmt.Fprintf(os.Stderr, "Health check failed: %v\n", err)
        os.Exit(1)
    }
    defer resp.Body.Close()
    
    if resp.StatusCode != 200 {
        fmt.Fprintf(os.Stderr, "Unexpected status code: %d\n", resp.StatusCode)
        os.Exit(1)
    }
    
    fmt.Println("Health check passed")
}
EOF

RUN go build -ldflags="-w -s" -trimpath -o healthcheck healthcheck.go

# Stage 2: 最终镜像
FROM louislam/uptime-kuma:beta-rootless

USER root

# 替换 healthcheck
COPY --from=healthcheck-builder /build/healthcheck /app/extra/healthcheck
RUN chmod +x /app/extra/healthcheck && \
    chown 10014:10014 /app/extra/healthcheck

USER 10014
